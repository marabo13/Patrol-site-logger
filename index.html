<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Patrol Logger</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0b0214;
  color:#f7f2ff;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
}
.panel{
  width:100%;
  max-width:540px;
  padding:18px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.06);
}
h1{margin:0 0 6px;font-size:22px}
p{margin:0 0 14px;color:#cdb7ff;font-size:13px}

label{display:block;margin:10px 0 6px;color:#cdb7ff;font-size:13px}
input, select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:#0b0114;
  color:#fff;
}

button{
  width:100%;
  padding:16px;
  margin-top:12px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  font-weight:900;
  font-size:15px;
}
.start{background:#2ecc71;color:#081b10}
.end{background:#e74c3c;color:#1a0000}
button:disabled{opacity:.55;cursor:not-allowed}

#status{margin-top:12px;color:#cdb7ff;font-size:13px}
.hidden{display:none}
</style>
</head>

<body>
<div class="panel">
  <h1>Patrol Logger</h1>
  <p>DCoJ patrol logging system</p>

  <label>Username</label>
  <input id="username" placeholder="Your username">

  <label>DCoJ Enforcement Rank</label>
  <select id="rank">
    <option value="">-- Select rank --</option>
    <option>Arbiter</option>
    <option>Quaestor</option>
    <option>Praetor</option>
    <option>Sanctor</option>
    <option>Ast. Chief Arbiter</option>
    <option>Chief Arbiter</option>
  </select>

  <!-- SUPERVISOR (ONLY FOR ARBITER) -->
  <div id="mentorBlock" class="hidden">
    <label>Supervised by (Quaestor Mentor)</label>
    <input id="mentor" placeholder="Quaestor mentor username">
  </div>

  <button class="start" id="startBtn">üü¢ START PATROL</button>
  <button class="end" id="endBtn" disabled>üî¥ END PATROL</button>

  <div id="status"></div>
</div>

<script>
const STORAGE = {
  start: "patrolStartISO",
  user: "patrolUser",
  rank: "patrolRank",
  mentor: "patrolMentor"
};

const usernameEl = document.getElementById("username");
const rankEl = document.getElementById("rank");
const mentorEl = document.getElementById("mentor");
const mentorBlock = document.getElementById("mentorBlock");

const startBtn = document.getElementById("startBtn");
const endBtn = document.getElementById("endBtn");
const status = document.getElementById("status");

function get(k){return localStorage.getItem(k)}
function set(k,v){localStorage.setItem(k,v)}
function del(k){localStorage.removeItem(k)}

function refreshUI(){
  const rank = rankEl.value;
  const onPatrol = !!get(STORAGE.start);

  mentorBlock.classList.toggle("hidden", rank !== "Arbiter");

  startBtn.disabled = onPatrol;
  endBtn.disabled = !onPatrol;
}

async function send(action, extra={}){
  const res = await fetch("/.netlify/functions/patrol", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(extra)
  });
  const text = await res.text();
  let data={}; try{data=JSON.parse(text)}catch{}
  if(!res.ok) throw new Error(data.error || text);
}

startBtn.onclick = async () => {
  const username = usernameEl.value.trim();
  const rank = rankEl.value;
  const mentor = mentorEl.value.trim();

  if(!username || !rank){
    status.textContent = "‚ùå Username and rank required.";
    return;
  }

  if(rank === "Arbiter" && !mentor){
    status.textContent = "‚ùå Arbiter patrols require a Quaestor mentor.";
    return;
  }

  const startISO = new Date().toISOString();
  set(STORAGE.start, startISO);
  set(STORAGE.user, username);
  set(STORAGE.rank, rank);
  if(mentor) set(STORAGE.mentor, mentor);

  status.textContent = "Logging start...";
  try{
    await send("Start Patrol",{
      action:"Start Patrol",
      username,
      rank,
      mentor,
      startISO,
      time:startISO
    });
    status.textContent = "‚úÖ Patrol started.";
    refreshUI();
  }catch(e){
    del(STORAGE.start);
    status.textContent = "‚ùå "+e.message;
  }
};

endBtn.onclick = async () => {
  const endISO = new Date().toISOString();
  status.textContent = "Logging end...";
  try{
    await send("End Patrol",{
      action:"End Patrol",
      username:get(STORAGE.user),
      rank:get(STORAGE.rank),
      mentor:get(STORAGE.mentor),
      startISO:get(STORAGE.start),
      endISO,
      time:endISO
    });
    del(STORAGE.start); del(STORAGE.mentor);
    status.textContent = "‚úÖ Patrol ended.";
    refreshUI();
  }catch(e){
    status.textContent = "‚ùå "+e.message;
  }
};

rankEl.onchange = refreshUI;
refreshUI();
</script>
</body>
</html>

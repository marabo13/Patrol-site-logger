<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DCoJ Patrol Logger</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0b0214;
  color:#f7f2ff;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
}
.panel{
  width:100%;
  max-width:560px;
  padding:20px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.06);
}
h1{margin:0 0 6px;font-size:22px}
p{margin:0 0 14px;color:#cdb7ff;font-size:13px}

label{display:block;margin:10px 0 6px;color:#cdb7ff;font-size:13px}
input,select,textarea{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:#0b0114;
  color:#fff;
}
textarea{resize:vertical;min-height:80px}

button{
  width:100%;
  padding:16px;
  margin-top:12px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  font-weight:900;
  font-size:15px;
}
.start{background:#2ecc71;color:#081b10}
.end{background:#e74c3c;color:#1a0000}
.reset{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.15)}
button:disabled{opacity:.55;cursor:not-allowed}

#status{margin-top:12px;color:#cdb7ff;font-size:13px}
#live{margin-top:8px;color:#cdb7ff;font-size:13px}

.hidden{display:none}

/* Modal */
.modalBack{
  position:fixed; inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
}
.modal{
  width:100%;
  max-width:520px;
  background:#11031f;
  border:1px solid rgba(255,255,255,.15);
  border-radius:16px;
  padding:16px;
}
.modalHead{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.close{
  width:34px;height:34px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.08);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="panel">
  <h1>DCoJ Patrol Logger</h1>
  <p>Start and end patrols with automatic duration and reporting.</p>

  <label>Username</label>
  <input id="username" placeholder="Your username">

  <label>DCoJ Enforcement Rank</label>
  <select id="rank">
    <option value="">-- Select rank --</option>
    <option>Arbiter</option>
    <option>Quaestor</option>
    <option>Praetor</option>
    <option>Sanctor</option>
    <option>Ast. Chief Arbiter</option>
    <option>Chief Arbiter</option>
  </select>

  <div id="mentorBlock" class="hidden">
    <label>Supervised by (Quaestor Mentor)</label>
    <input id="mentor" placeholder="Quaestor mentor username">
  </div>

  <button class="start" id="startBtn">ðŸŸ¢ START PATROL</button>
  <button class="end" id="endBtn" disabled>ðŸ”´ END PATROL</button>
  <button class="reset" id="resetBtn">Reset</button>

  <div id="status"></div>
  <div id="live"></div>
</div>

<!-- END PATROL MODAL -->
<div class="modalBack" id="endModal">
  <div class="modal">
    <div class="modalHead">
      <b>End Patrol Details</b>
      <button class="close" id="closeModal">âœ•</button>
    </div>

    <label>Number of arrests</label>
    <input id="arrests" type="number" min="0" placeholder="0">

    <label>Attendees (comma or new line separated)</label>
    <textarea id="attendees" placeholder="Name1, Name2 OR one per line"></textarea>

    <button class="end" id="submitEnd">Submit End Patrol</button>
  </div>
</div>

<script>
const S={
  start:"patrolStart",
  user:"patrolUser",
  rank:"patrolRank",
  mentor:"patrolMentor"
};

const $=id=>document.getElementById(id);

function save(k,v){localStorage.setItem(k,v)}
function load(k){return localStorage.getItem(k)}
function del(k){localStorage.removeItem(k)}

function fmt(ms){
  const s=Math.floor(ms/1000);
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  const r=s%60;
  if(h) return `${h}h ${m}m ${r}s`;
  if(m) return `${m}m ${r}s`;
  return `${r}s`;
}

function refresh(){
  $("mentorBlock").classList.toggle("hidden",$("rank").value!=="Arbiter");

  const on=!!load(S.start);
  $("startBtn").disabled=on;
  $("endBtn").disabled=!on;

  if(on){
    const d=Date.now()-new Date(load(S.start));
    $("live").textContent=`On patrol â€¢ Duration: ${fmt(d)}`;
  }else{
    $("live").textContent="Not on patrol.";
  }
}

async function send(data){
  const r=await fetch("/.netlify/functions/patrol",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });
  const text = await r.text();
  if(!r.ok) throw new Error(text);
}

$("startBtn").onclick=async()=>{
  const u=$("username").value.trim();
  const r=$("rank").value;
  const m=$("mentor").value.trim();

  if(!u||!r){$("status").textContent="âŒ Username and rank required.";return;}
  if(r==="Arbiter"&&!m){$("status").textContent="âŒ Arbiter requires Quaestor mentor.";return;}

  const t=new Date().toISOString();
  save(S.start,t); save(S.user,u); save(S.rank,r); if(m) save(S.mentor,m);

  $("status").textContent="Logging start...";
  try{
    await send({action:"Start Patrol",username:u,rank:r,mentor:m,startISO:t,time:t});
    $("status").textContent="âœ… Patrol started.";
  }catch(e){
    del(S.start);
    $("status").textContent="âŒ " + e.message;
  }
  refresh();
};

$("endBtn").onclick=()=>{
  $("endModal").style.display="flex";
  $("arrests").value="";
  $("attendees").value="";
};

$("closeModal").onclick=()=>$("endModal").style.display="none";

$("submitEnd").onclick=async()=>{
  const end=new Date().toISOString();
  const start=load(S.start);

  const arrests=$("arrests").value||"0";

  // âœ… attendees array (unique)
  const attendees=[...new Set(
    $("attendees").value.split(/[\n,]+/).map(x=>x.trim()).filter(Boolean)
  )];

  $("status").textContent="Logging end...";
  try{
    await send({
      action:"End Patrol",
      username:load(S.user),
      rank:load(S.rank),
      mentor:load(S.mentor) || "",
      startISO:start,
      endISO:end,
      durationText:fmt(new Date(end)-new Date(start)),
      arrests,
      attendees,
      time:end
    });
    del(S.start);
    $("status").textContent="âœ… Patrol ended.";
    $("endModal").style.display="none";
  }catch(e){
    $("status").textContent="âŒ " + e.message;
  }
  refresh();
};

$("resetBtn").onclick=()=>{Object.values(S).forEach(del);refresh();};

$("rank").onchange=refresh;
refresh();
setInterval(refresh,1000);
</script>
</body>
</html>
